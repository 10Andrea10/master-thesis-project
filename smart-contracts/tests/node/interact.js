const tezosImport = require("@taquito/taquito");
signerImport = require("@taquito/signer");

const RPC_NODE = "https://ghostnet.ecadinfra.com/";
const PRIV_KEY =
    "edskS649knDsPqecjwzFM1YXr2nDoXACBuzmsgG8jxTaySB8d86e9mRW39wvfgnJy4tKkbgv44dv2iECJQPHrBYtkKZq9P51q2";
const ZK_ROLLUP_ADDRESS = "KT1GC3AuTBURL1KqFdnGHoHkV2dgqRfNqznY";

const zkRollupContract = ZK_ROLLUP_ADDRESS;

const Tezos = new tezosImport.TezosToolkit(RPC_NODE);

Tezos.setProvider({
    signer: new signerImport.InMemorySigner(PRIV_KEY),
});

const proofConvertedManually = {
    proof: {
        a: "0x16d2bc574ddbb1775af7ac6b163cf185039c7a0d1eeb69018984fefaaf25c08be63e63b54429f6e2f54b82adc1dab78f04e9216a957f2b2fb381a898d780013c56a16203f211706dd78ccf2c24890fc26caa2b0bfec5b2b08c319ce1f6bb7c49",
        b: "0x0fc9e910e694d8ef4d2251ea5e19e38cf2640ac3ae742ef6dc2df2898351ec063a5c50c30b934e29a60b45d257da343608ee62bfebb6fc76d05f6af663e5ace5f38a5e9ae4cc51d4c4cbd1375e72b8d30a5efe9760569c785be88a977bbb1baa0a8a490301502171949e2652754100eaae568b632c5e275a39a3a04dc5f10e0f2ca36cb4616395719af84cfbd1bec4c20149b064182fc438b272e77ea1c0932502b51837d6778a53fc4ceb4b560b01eedadb04c61ed7bd356c4824cbdb320d27",
        c: "0x12b097d1e0833683724ea21269936a47efacdbe2479a07a38730c53a82c2e27e996dc7300fe66eed5c2c5c6c256258d708266087f797198530bbb2af1738ce417a21a107d5357614bc65732662537a347b0eab699d03c24ed4b7494430f50822",
    },
    inputs: [
        "c145ef0800000000000000000000000000000000000000000000000000000000",
        "2acc5ff700000000000000000000000000000000000000000000000000000000",
        "1278102d00000000000000000000000000000000000000000000000000000000",
        "7a0239bb00000000000000000000000000000000000000000000000000000000",
        "004a2d3f00000000000000000000000000000000000000000000000000000000",
        "050d53ff00000000000000000000000000000000000000000000000000000000",
        "0473569500000000000000000000000000000000000000000000000000000000",
        "4d05a21800000000000000000000000000000000000000000000000000000000",
        "45014a1d00000000000000000000000000000000000000000000000000000000",
        "fd955a1c00000000000000000000000000000000000000000000000000000000",
        "ced6af1100000000000000000000000000000000000000000000000000000000",
        "ed8a6c6500000000000000000000000000000000000000000000000000000000",
        "473d4b5700000000000000000000000000000000000000000000000000000000",
        "cbe9aa6a00000000000000000000000000000000000000000000000000000000",
        "4f91a9a400000000000000000000000000000000000000000000000000000000",
        "6136db2700000000000000000000000000000000000000000000000000000000",
        "bd346dc0deffdd35000000000000000000000000000000000000000000000000",
        "bf5ca5b8b8fbf057000000000000000000000000000000000000000000000000",
        "ca9f14d118272d66000000000000000000000000000000000000000000000000",
        "9b7e3b2d392cfc82000000000000000000000000000000000000000000000000",
        "d485333900f03229000000000000000000000000000000000000000000000000",
        "63fa36bca6f783bb000000000000000000000000000000000000000000000000",
        "5f2768b3912c65c6000000000000000000000000000000000000000000000000",
        "013783096798f61e000000000000000000000000000000000000000000000000",
        "0000000000000000000000000000000000000000000000000000000000000000",
        "1590f521e730e408000000000000000000000000000000000000000000000000",
        "ace470dcdc2d6d85000000000000000000000000000000000000000000000000",
        "930be5246b5bc936000000000000000000000000000000000000000000000000",
        "390035a2e4563011000000000000000000000000000000000000000000000000",
        "79b18c19826b006c000000000000000000000000000000000000000000000000",
        "128fd0ed1b6c30e8000000000000000000000000000000000000000000000000",
        "02e18688323f86dc000000000000000000000000000000000000000000000000",
        "dceb94800007e903000000000000000000000000000000000000000000000000",
        "18842868a2000003000000000000000000000000000000000000000000000000",
        "3808d4a1a2f3d390000000000000000000000000000000000000000000000000",
        "000105fe82a8c739000000000000000000000000000000000000000000000000",
        "0e778a799b9459ed000000000000000000000000000000000000000000000000",
        "3a8302628bd8cce7000000000000000000000000000000000000000000000000",
        "64818d75913a4bb5000000000000000000000000000000000000000000000000",
        "e2751f985bd8745f000000000000000000000000000000000000000000000000",
        "014b92b764b89bb7000000000000000000000000000000000000000000000000",
        "c2094f22e0b2aadc000000000000000000000000000000000000000000000000",
        "9fb43f27b76d7f60000000000000000000000000000000000000000000000000",
        "0abb6fa270959f47000000000000000000000000000000000000000000000000",
        "e803000000000000000000000000000000000000000000000000000000000000",
        "0300000000000000000000000000000000000000000000000000000000000000",
        "a44bf85b31d94bf2000000000000000000000000000000000000000000000000",
        "42fdddeec78aeb92000000000000000000000000000000000000000000000000",
        "8ee0b1c0c5734462000000000000000000000000000000000000000000000000",
        "f93d256c152f558b000000000000000000000000000000000000000000000000",
        "938d8c3aa78cac5c000000000000000000000000000000000000000000000000",
        "55fdb0ec22aea240000000000000000000000000000000000000000000000000",
        "cbafa4378f78972a000000000000000000000000000000000000000000000000",
        "001ff0cd67d53b06000000000000000000000000000000000000000000000000",
        "0000000000000000000000000000000000000000000000000000000000000000",
        "ded92f96f1d2dc1a000000000000000000000000000000000000000000000000",
        "97a19875f53c79de000000000000000000000000000000000000000000000000",
        "3d8e8374773f736e000000000000000000000000000000000000000000000000",
        "c4e3c495eefb5648000000000000000000000000000000000000000000000000",
        "79b18c19826b006c000000000000000000000000000000000000000000000000",
        "128fd0ed1b6c30e8000000000000000000000000000000000000000000000000",
        "02e18688323f86dc000000000000000000000000000000000000000000000000",
        "dceb94800007e903000000000000000000000000000000000000000000000000",
        "7d83fce6e6000003000000000000000000000000000000000000000000000000",
        "e9f790ecde6abb8f000000000000000000000000000000000000000000000000",
        "00dd8653604a4b1b000000000000000000000000000000000000000000000000",
        "81511539c4679017000000000000000000000000000000000000000000000000",
        "ddf1e5b6bf9197fc000000000000000000000000000000000000000000000000",
        "639e8662969f9b04000000000000000000000000000000000000000000000000",
        "f50fa1c861078979000000000000000000000000000000000000000000000000",
        "971c7887e7672641000000000000000000000000000000000000000000000000",
        "bef8ed90bcbaae57000000000000000000000000000000000000000000000000",
        "81f207d2cd29fe71000000000000000000000000000000000000000000000000",
        "073eec6d2dc3fc18000000000000000000000000000000000000000000000000",
        "e803000000000000000000000000000000000000000000000000000000000000",
        "0200000000000000000000000000000000000000000000000000000000000000",
        "05452b1e22390f39000000000000000000000000000000000000000000000000",
        "91724d273cd40f89000000000000000000000000000000000000000000000000",
        "70a7d82cfd4a3683000000000000000000000000000000000000000000000000",
        "365919ba2c5ea0ba000000000000000000000000000000000000000000000000",
        "9616eab416e782cf000000000000000000000000000000000000000000000000",
        "bd35be53a07b7cd0000000000000000000000000000000000000000000000000",
        "3c95c2d54073e488000000000000000000000000000000000000000000000000",
        "026650f316b00dbe000000000000000000000000000000000000000000000000",
        "0000000000000000000000000000000000000000000000000000000000000000",
        "452d30d41a21f61a000000000000000000000000000000000000000000000000",
        "89931fd38779b3b8000000000000000000000000000000000000000000000000",
        "c8b211d5080a1c85000000000000000000000000000000000000000000000000",
        "180cf3d363018e41000000000000000000000000000000000000000000000000",
        "8f7d83fce6e6006c000000000000000000000000000000000000000000000000",
        "1be9f790ecde6abb000000000000000000000000000000000000000000000000",
        "02e1dd8653604a4b000000000000000000000000000000000000000000000000",
        "eeb5ca800007e901000000000000000000000000000000000000000000000000",
        "b18c19826b000001000000000000000000000000000000000000000000000000",
        "8fd0ed1b6c30e879000000000000000000000000000000000000000000000000",
        "008688323f86dc12000000000000000000000000000000000000000000000000",
        "1ecb9d5a9c3eb72a000000000000000000000000000000000000000000000000",
        "ed8993f9c48fbf4b000000000000000000000000000000000000000000000000",
        "d531a7c9b3244300000000000000000000000000000000000000000000000000",
        "d0f9d031e722acf0000000000000000000000000000000000000000000000000",
        "5991d76f6213b3d3000000000000000000000000000000000000000000000000",
        "7b526bdc251f3207000000000000000000000000000000000000000000000000",
        "d41fe867bd5c9644000000000000000000000000000000000000000000000000",
        "0ef80b2080773604000000000000000000000000000000000000000000000000",
        "f401000000000000000000000000000000000000000000000000000000000000",
        "0400000000000000000000000000000000000000000000000000000000000000",
        "1cf312a500000000000000000000000000000000000000000000000000000000",
        "289d271200000000000000000000000000000000000000000000000000000000",
        "64e4a1c500000000000000000000000000000000000000000000000000000000",
        "1373ca5d00000000000000000000000000000000000000000000000000000000",
        "80effea500000000000000000000000000000000000000000000000000000000",
        "aa5a754200000000000000000000000000000000000000000000000000000000",
        "acf1a31300000000000000000000000000000000000000000000000000000000",
        "a0daab0100000000000000000000000000000000000000000000000000000000",
        "e4c02d0000000000000000000000000000000000000000000000000000000000",
        "344d4c0000000000000000000000000000000000000000000000000000000000",
        "e803000000000000000000000000000000000000000000000000000000000000",
        "0000000000000000000000000000000000000000000000000000000000000000",
        "0400000000000000000000000000000000000000000000000000000000000000",
        "0200000000000000000000000000000000000000000000000000000000000000",
        "0100000000000000000000000000000000000000000000000000000000000000",
        "0100000000000000000000000000000000000000000000000000000000000000",
    ],
};

// Call the smart contract
callRollUpSmartContract(proofConvertedManually);

async function callRollUpSmartContract(proofConverted) {
    // Convert the proofConverted to a JSON object
    //var proofConvertedJSON = JSON.parse(proofConverted);
    var proofConvertedJSON = proofConverted;

    const inputsConverted = proofConvertedJSON.inputs;
    inputsMichelsonMap = new tezosImport.MichelsonMap();
    // Add the inputs to the map
    for (let i = 0; i < inputsConverted.length; i++) {
        inputsMichelsonMap.set(i, inputsConverted[i]);
    }
    // Remove prefix 0x from the proof.a, proof.b and proof.c
    proofConvertedJSON.proof.a = proofConvertedJSON.proof.a.replace("0x", "");
    proofConvertedJSON.proof.b = proofConvertedJSON.proof.b.replace("0x", "");
    proofConvertedJSON.proof.c = proofConvertedJSON.proof.c.replace("0x", "");

    Tezos.contract
        .at(zkRollupContract)
        .then((contract) => {
            console.log(`Calling contract: ${zkRollupContract}...`);
            return contract.methods
                .receive_rollup_proof(
                    proofConvertedJSON.proof.a,
                    proofConvertedJSON.proof.b,
                    proofConvertedJSON.proof.c,
                    inputsMichelsonMap,
                )
                .send();
        })
        .then(async (op) => {
            console.log(`Waiting for ${op.hash} to be confirmed...`);
            await op.confirmation(1);
            return op.hash;
        })
        .then((hash) => console.log(`Operation injected: https://ghostnet.tzkt.io/${hash}`))
        .catch((error) => console.log(error));
}
