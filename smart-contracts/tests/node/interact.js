const tezosImport = require("@taquito/taquito");
signerImport = require("@taquito/signer");

const RPC_NODE = "https://ghostnet.ecadinfra.com/";
const PRIV_KEY =
    "edskS649knDsPqecjwzFM1YXr2nDoXACBuzmsgG8jxTaySB8d86e9mRW39wvfgnJy4tKkbgv44dv2iECJQPHrBYtkKZq9P51q2";
const ZK_ROLLUP_ADDRESS = "KT1Gog2kgXXW2EgmhdYxURsPx43oejzsx2U2";

const zkRollupContract = ZK_ROLLUP_ADDRESS;

const Tezos = new tezosImport.TezosToolkit(RPC_NODE);

Tezos.setProvider({
    signer: new signerImport.InMemorySigner(PRIV_KEY),
});

const proofConvertedManually = {
    proof: {
        a: "0x0db81eb84c986582574d0c85a2382377245ca04974e264cf50d05acb534b73059f935e8173b7551b3bb9ca3f60f2e60a0527c58545fdde5a5df3fa6d3987dfa9e371d33dcad59ad1209507cc23d7e92c520454d64f90753957f80a24e4be9b98",
        b: "0x161e67dbda17fc80852f7e8037cb692f26ca3da2a08ace3011f542736f3e109b15878e85148b1a86bd6edd0b0a98fa9c10fa9f4f6d09b54168ec3fbdb09fe5f9f9483b6f3c3b0cf02afd84b2d8b45a24a9ee1649f43d94875238c574ee9148cb1099c0004dc782740ae849ec180755a78266af0514ab0d47bb43eb06f220fa6d6cf4759d9eb97d45da77fc63928c7f050c7f3e90913a991d652919e6a4b2e6bbb3926930e531838cab3d5d0e96d13e7a3307ac54d70bf2d3968fc57f7e7607eb",
        c: "0x03efdb5342284bcc8393023c6caeacaf8c3106bad2c2b7cce4c36159577f647b18186e2d673360a96fbb614e9084fbd101e78443045b1d1ea2a31ba68150040c00ae5b0a34ddd94473b5c2f7728a41e031cc02ab089903f1064389e10c41d9f9",
    },
    inputs: [
        "c145ef0800000000000000000000000000000000000000000000000000000000",
        "2acc5ff700000000000000000000000000000000000000000000000000000000",
        "1278102d00000000000000000000000000000000000000000000000000000000",
        "7a0239bb00000000000000000000000000000000000000000000000000000000",
        "004a2d3f00000000000000000000000000000000000000000000000000000000",
        "050d53ff00000000000000000000000000000000000000000000000000000000",
        "0473569500000000000000000000000000000000000000000000000000000000",
        "4d05a21800000000000000000000000000000000000000000000000000000000",
        "45014a1d00000000000000000000000000000000000000000000000000000000",
        "fd955a1c00000000000000000000000000000000000000000000000000000000",
        "ced6af1100000000000000000000000000000000000000000000000000000000",
        "ed8a6c6500000000000000000000000000000000000000000000000000000000",
        "473d4b5700000000000000000000000000000000000000000000000000000000",
        "cbe9aa6a00000000000000000000000000000000000000000000000000000000",
        "4f91a9a400000000000000000000000000000000000000000000000000000000",
        "6136db2700000000000000000000000000000000000000000000000000000000",
        "bd346dc0deffdd35000000000000000000000000000000000000000000000000",
        "bf5ca5b8b8fbf057000000000000000000000000000000000000000000000000",
        "ca9f14d118272d66000000000000000000000000000000000000000000000000",
        "9b7e3b2d392cfc82000000000000000000000000000000000000000000000000",
        "d485333900f03229000000000000000000000000000000000000000000000000",
        "63fa36bca6f783bb000000000000000000000000000000000000000000000000",
        "5f2768b3912c65c6000000000000000000000000000000000000000000000000",
        "013783096798f61e000000000000000000000000000000000000000000000000",
        "0000000000000000000000000000000000000000000000000000000000000000",
        "1590f521e730e408000000000000000000000000000000000000000000000000",
        "ace470dcdc2d6d85000000000000000000000000000000000000000000000000",
        "930be5246b5bc936000000000000000000000000000000000000000000000000",
        "390035a2e4563011000000000000000000000000000000000000000000000000",
        "79b18c19826b006c000000000000000000000000000000000000000000000000",
        "128fd0ed1b6c30e8000000000000000000000000000000000000000000000000",
        "02e18688323f86dc000000000000000000000000000000000000000000000000",
        "dceb94800007e903000000000000000000000000000000000000000000000000",
        "18842868a2000003000000000000000000000000000000000000000000000000",
        "3808d4a1a2f3d390000000000000000000000000000000000000000000000000",
        "000105fe82a8c739000000000000000000000000000000000000000000000000",
        "0e778a799b9459ed000000000000000000000000000000000000000000000000",
        "3a8302628bd8cce7000000000000000000000000000000000000000000000000",
        "64818d75913a4bb5000000000000000000000000000000000000000000000000",
        "e2751f985bd8745f000000000000000000000000000000000000000000000000",
        "014b92b764b89bb7000000000000000000000000000000000000000000000000",
        "c2094f22e0b2aadc000000000000000000000000000000000000000000000000",
        "9fb43f27b76d7f60000000000000000000000000000000000000000000000000",
        "0abb6fa270959f47000000000000000000000000000000000000000000000000",
        "e803000000000000000000000000000000000000000000000000000000000000",
        "0300000000000000000000000000000000000000000000000000000000000000",
        "a44bf85b31d94bf2000000000000000000000000000000000000000000000000",
        "42fdddeec78aeb92000000000000000000000000000000000000000000000000",
        "8ee0b1c0c5734462000000000000000000000000000000000000000000000000",
        "f93d256c152f558b000000000000000000000000000000000000000000000000",
        "938d8c3aa78cac5c000000000000000000000000000000000000000000000000",
        "55fdb0ec22aea240000000000000000000000000000000000000000000000000",
        "cbafa4378f78972a000000000000000000000000000000000000000000000000",
        "001ff0cd67d53b06000000000000000000000000000000000000000000000000",
        "0000000000000000000000000000000000000000000000000000000000000000",
        "ded92f96f1d2dc1a000000000000000000000000000000000000000000000000",
        "97a19875f53c79de000000000000000000000000000000000000000000000000",
        "3d8e8374773f736e000000000000000000000000000000000000000000000000",
        "c4e3c495eefb5648000000000000000000000000000000000000000000000000",
        "79b18c19826b006c000000000000000000000000000000000000000000000000",
        "128fd0ed1b6c30e8000000000000000000000000000000000000000000000000",
        "02e18688323f86dc000000000000000000000000000000000000000000000000",
        "dceb94800007e903000000000000000000000000000000000000000000000000",
        "7d83fce6e6000003000000000000000000000000000000000000000000000000",
        "e9f790ecde6abb8f000000000000000000000000000000000000000000000000",
        "00dd8653604a4b1b000000000000000000000000000000000000000000000000",
        "81511539c4679017000000000000000000000000000000000000000000000000",
        "ddf1e5b6bf9197fc000000000000000000000000000000000000000000000000",
        "639e8662969f9b04000000000000000000000000000000000000000000000000",
        "f50fa1c861078979000000000000000000000000000000000000000000000000",
        "971c7887e7672641000000000000000000000000000000000000000000000000",
        "bef8ed90bcbaae57000000000000000000000000000000000000000000000000",
        "81f207d2cd29fe71000000000000000000000000000000000000000000000000",
        "073eec6d2dc3fc18000000000000000000000000000000000000000000000000",
        "e803000000000000000000000000000000000000000000000000000000000000",
        "0200000000000000000000000000000000000000000000000000000000000000",
        "05452b1e22390f39000000000000000000000000000000000000000000000000",
        "91724d273cd40f89000000000000000000000000000000000000000000000000",
        "70a7d82cfd4a3683000000000000000000000000000000000000000000000000",
        "365919ba2c5ea0ba000000000000000000000000000000000000000000000000",
        "9616eab416e782cf000000000000000000000000000000000000000000000000",
        "bd35be53a07b7cd0000000000000000000000000000000000000000000000000",
        "3c95c2d54073e488000000000000000000000000000000000000000000000000",
        "026650f316b00dbe000000000000000000000000000000000000000000000000",
        "0000000000000000000000000000000000000000000000000000000000000000",
        "452d30d41a21f61a000000000000000000000000000000000000000000000000",
        "89931fd38779b3b8000000000000000000000000000000000000000000000000",
        "c8b211d5080a1c85000000000000000000000000000000000000000000000000",
        "180cf3d363018e41000000000000000000000000000000000000000000000000",
        "8f7d83fce6e6006c000000000000000000000000000000000000000000000000",
        "1be9f790ecde6abb000000000000000000000000000000000000000000000000",
        "02e1dd8653604a4b000000000000000000000000000000000000000000000000",
        "eeb5ca800007e901000000000000000000000000000000000000000000000000",
        "b18c19826b000001000000000000000000000000000000000000000000000000",
        "8fd0ed1b6c30e879000000000000000000000000000000000000000000000000",
        "008688323f86dc12000000000000000000000000000000000000000000000000",
        "1ecb9d5a9c3eb72a000000000000000000000000000000000000000000000000",
        "ed8993f9c48fbf4b000000000000000000000000000000000000000000000000",
        "d531a7c9b3244300000000000000000000000000000000000000000000000000",
        "d0f9d031e722acf0000000000000000000000000000000000000000000000000",
        "5991d76f6213b3d3000000000000000000000000000000000000000000000000",
        "7b526bdc251f3207000000000000000000000000000000000000000000000000",
        "d41fe867bd5c9644000000000000000000000000000000000000000000000000",
        "0ef80b2080773604000000000000000000000000000000000000000000000000",
        "f401000000000000000000000000000000000000000000000000000000000000",
        "0400000000000000000000000000000000000000000000000000000000000000",
        "1cf312a500000000000000000000000000000000000000000000000000000000",
        "289d271200000000000000000000000000000000000000000000000000000000",
        "64e4a1c500000000000000000000000000000000000000000000000000000000",
        "1373ca5d00000000000000000000000000000000000000000000000000000000",
        "80effea500000000000000000000000000000000000000000000000000000000",
        "aa5a754200000000000000000000000000000000000000000000000000000000",
        "acf1a31300000000000000000000000000000000000000000000000000000000",
        "a0daab0100000000000000000000000000000000000000000000000000000000",
        "e4c02d0000000000000000000000000000000000000000000000000000000000",
        "344d4c0000000000000000000000000000000000000000000000000000000000",
        "e803000000000000000000000000000000000000000000000000000000000000",
        "0000000000000000000000000000000000000000000000000000000000000000",
        "0400000000000000000000000000000000000000000000000000000000000000",
        "0200000000000000000000000000000000000000000000000000000000000000",
        "0100000000000000000000000000000000000000000000000000000000000000",
        "0100000000000000000000000000000000000000000000000000000000000000",
    ],
};

// Call the smart contract
callRollUpSmartContract(proofConvertedManually);

async function callRollUpSmartContract(proofConverted) {
    // Convert the proofConverted to a JSON object
    //var proofConvertedJSON = JSON.parse(proofConverted);
    var proofConvertedJSON = proofConverted;

    const inputsConverted = proofConvertedJSON.inputs;
    inputsMichelsonMap = new tezosImport.MichelsonMap();
    // Add the inputs to the map
    for (let i = 0; i < inputsConverted.length; i++) {
        inputsMichelsonMap.set(i, inputsConverted[i]);
    }
    // Remove prefix 0x from the proof.a, proof.b and proof.c
    proofConvertedJSON.proof.a = proofConvertedJSON.proof.a.replace("0x", "");
    proofConvertedJSON.proof.b = proofConvertedJSON.proof.b.replace("0x", "");
    proofConvertedJSON.proof.c = proofConvertedJSON.proof.c.replace("0x", "");

    Tezos.contract
        .at(zkRollupContract)
        .then((contract) => {
            console.log(`Calling contract: ${zkRollupContract}...`);
            return contract.methods
                .receive_rollup_proof(
                    proofConvertedJSON.proof.a,
                    proofConvertedJSON.proof.b,
                    proofConvertedJSON.proof.c,
                    inputsMichelsonMap,
                )
                .send();
        })
        .then(async (op) => {
            console.log(`Waiting for ${op.hash} to be confirmed...`);
            await op.confirmation(1);
            return op.hash;
        })
        .then((hash) => console.log(`Operation injected: https://ghostnet.tzkt.io/${hash}`))
        .catch((error) => console.log(error));
}
