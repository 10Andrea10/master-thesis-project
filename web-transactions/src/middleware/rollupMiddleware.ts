import {Request, Response} from 'express';
import {MongoInteractor} from '../services/mongoInteractor';

import got from 'got';
import {TezosInteractor} from '../services/tezosInteractor';
import {Rollup} from '../typings/rollup';
import {convertProof} from '../utils/proofConverter';

export class RollupMiddleware {
  constructor(
    private readonly mongoInteractor: MongoInteractor,
    private readonly tezosInteractor: TezosInteractor
  ) {
    this.executeRollup = this.executeRollup.bind(this);
  }

  async executeRollup(request: Request, response: Response): Promise<void> {
    const privateSignerKey = request.body.privateSignerKey;
    const transactions = await this.mongoInteractor.getTransactions();
    const {publicKeys, balances, nonces} =
      await this.tezosInteractor.getBigMapValues();
    const addressesTreeRoot = await this.tezosInteractor.getMKRoot(
      'mr_pub_key'
    );
    const balanceNonceTreeRoot = await this.tezosInteractor.getMKRoot(
      'mr_balance_nonce'
    );
    const rollup = new Rollup(
      addressesTreeRoot,
      balanceNonceTreeRoot,
      transactions,
      publicKeys,
      balances,
      nonces
    );
    const zokratesInputs = rollup.toZokratesInput();
    // const proof = await got.post(
    //   process.env.WEB_ROLLUP_SERVER_URL + '/execute',
    //   {
    //     body: JSON.stringify(zokratesInputs),
    //     headers: {'Content-Type': 'text/plain'},
    //     throwHttpErrors: false,
    //   }
    // );
    // if(proof.statusCode !== 200) {
    //   response.status(proof.statusCode).send(proof.body);
    // }

    // // TODO: interact with the Tezos blockchain to update the storage.

    // const proofConverted = convertProof(proof.body);

    const proofConverted =
      '{"scheme":"gm17","curve":"bls12_381","proof":{"a":"0x0328f332890f013aafc5930e615a2e30d079a40606cade0f48807352fa13b61790378d8db971ad6d2294146dcb0c82cd0dda1dcb2da8290361561c194471631c4e264ac53179b5c4581ee1ab790c7e366e93581d9e820823691b6462fb0f2b5f","b":"0x1565e7abfe0b3e614d53b18dd9647f757fd9eedbb9518ac3cb532310a07cfb65c86f0edfa64b4724b3da735b01c0ce600946879997639715b46bd86fc689c4e2c09f6a58e9ea706008a7868c69c63e4d423eaaaf9b29b7f2e99713e87e79b78c02d7a3bd157e3dcbec0ea1153b2ec254c978b7ef4e24d58079bc3a11f9f17f1bb156d71e13bdeb5d73b46d84a47cd3e501db0db9969d9f662dc722b797a765d303273c30e90b2f1808f4c78464f7cd72ed7ba18e60df5b65c11f5f6881edc21e","c":"0x028c7acf35680192549f1dba0e9f16ed9ffc1fdc7d5325af75d19dad48f0d9fbe5e6536eb3c9ee2e5f086454f4df0b26140d0953d493d480603d87a8cfae16022e9964d9f331a2c5bd3a49592a82833584b72b9f6eebb894f9cadf56bad2d05f"},"inputs":["c145ef0800000000000000000000000000000000000000000000000000000000","2acc5ff700000000000000000000000000000000000000000000000000000000","1278102d00000000000000000000000000000000000000000000000000000000","7a0239bb00000000000000000000000000000000000000000000000000000000","004a2d3f00000000000000000000000000000000000000000000000000000000","050d53ff00000000000000000000000000000000000000000000000000000000","0473569500000000000000000000000000000000000000000000000000000000","4d05a21800000000000000000000000000000000000000000000000000000000","45014a1d00000000000000000000000000000000000000000000000000000000","fd955a1c00000000000000000000000000000000000000000000000000000000","ced6af1100000000000000000000000000000000000000000000000000000000","ed8a6c6500000000000000000000000000000000000000000000000000000000","473d4b5700000000000000000000000000000000000000000000000000000000","cbe9aa6a00000000000000000000000000000000000000000000000000000000","4f91a9a400000000000000000000000000000000000000000000000000000000","6136db2700000000000000000000000000000000000000000000000000000000","29a5857f43a41379000000000000000000000000000000000000000000000000","bc792b85508b0132000000000000000000000000000000000000000000000000","5da4d1c1c3e715f1000000000000000000000000000000000000000000000000","e9062ab9d772a106000000000000000000000000000000000000000000000000","d7f1331bf2dd25b1000000000000000000000000000000000000000000000000","099e5c42e16b525c000000000000000000000000000000000000000000000000","c18d9d7b3870844b000000000000000000000000000000000000000000000000","0aac113f9685f1df000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","9b00000000000000000000000000000000000000000000000000000000000000","0200000000000000000000000000000000000000000000000000000000000000","b362df89aeafa9ce000000000000000000000000000000000000000000000000","6478affa3586a936000000000000000000000000000000000000000000000000","b1a8455033dc0b72000000000000000000000000000000000000000000000000","70830e5492a9d3a7000000000000000000000000000000000000000000000000","3a75f98aaa2c9b22000000000000000000000000000000000000000000000000","c2ca6ebf94e2fa22000000000000000000000000000000000000000000000000","def330c1ecab7a4b000000000000000000000000000000000000000000000000","026c011df0f36dc7000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","5e00000000000000000000000000000000000000000000000000000000000000","0300000000000000000000000000000000000000000000000000000000000000","9a684138a2dcb337000000000000000000000000000000000000000000000000","c7f51efef6937db6000000000000000000000000000000000000000000000000","02212e98caceefbe000000000000000000000000000000000000000000000000","38b65b9577f77d92000000000000000000000000000000000000000000000000","4dfdf271b87e3c54000000000000000000000000000000000000000000000000","a4209fdcc6c47659000000000000000000000000000000000000000000000000","f00a3ca3ed89c471000000000000000000000000000000000000000000000000","00688b10b568dca0000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","0000000000000000000000000000000000000000000000000000000000000000","2d00000000000000000000000000000000000000000000000000000000000000","0400000000000000000000000000000000000000000000000000000000000000","733c507600000000000000000000000000000000000000000000000000000000","aebfd87800000000000000000000000000000000000000000000000000000000","fbb7952300000000000000000000000000000000000000000000000000000000","7ac07a7a00000000000000000000000000000000000000000000000000000000","980c57d700000000000000000000000000000000000000000000000000000000","dad721ef00000000000000000000000000000000000000000000000000000000","37c16aa300000000000000000000000000000000000000000000000000000000","09a8367c00000000000000000000000000000000000000000000000000000000","35c62d0000000000000000000000000000000000000000000000000000000000","034b4c0000000000000000000000000000000000000000000000000000000000","2d00000000000000000000000000000000000000000000000000000000000000","9b00000000000000000000000000000000000000000000000000000000000000","0400000000000000000000000000000000000000000000000000000000000000","0200000000000000000000000000000000000000000000000000000000000000","0100000000000000000000000000000000000000000000000000000000000000","0100000000000000000000000000000000000000000000000000000000000000"]}';

    const result = await this.tezosInteractor.callRollUpSmartContract(
      proofConverted,
      privateSignerKey
    );
    response.status(200).send(result);
  }
}
